<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>èºæ—‹å†’éšª V13</title>
    <style>
        :root { --bg: #0d0d0d; --gold: #c5a059; --finish: #e67e22; --border: #333; --accent: #ff6b6b; --modal-bg: rgba(20,20,20,0.98); }

        /* ä¿®æ­£é» 1: ä¸è¦å°æ‰€æœ‰å…ƒç´ ç¦ç”¨ touch-actionï¼Œåªå°éŠæˆ²è¦–çª—ç¦ç”¨ */
        * { box-sizing: border-box; }
        body, html { background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }

        .page {
            position: absolute; inset: 0; z-index: 1000; background: #111;
            display: none; flex-direction: column; align-items: center;
            padding: 20px; overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* è®“ iPhone æ²å‹•é †æš¢ */
        }
        .active { display: flex; }

        .btn { width: 100%; max-width: 300px; padding: 15px; margin: 8px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; text-align: center; font-size: 16px; flex-shrink: 0; }
        .btn-back { background: #444; color: #fff; margin-top: 20px; }
        .btn-small { padding: 8px 12px; width: auto; font-size: 12px; margin: 5px; background: var(--gold); border-radius: 5px; color: #000; border: none; }

        .card { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); width: 100%; max-width: 800px; flex-shrink: 0; }

        /* éŠæˆ²å€åŸŸ */
        #game-view { position: fixed; inset: 0; width: 100vw; height: 100vh; background: #000; z-index: 500; display: none; touch-action: none; }
        #world { position: absolute; transform-origin: center; pointer-events: none; }
        .cell { position: absolute; width: 92px; height: 92px; border: 1px solid var(--border); background: #161616; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 5px; font-size: 11px; pointer-events: auto; }
        .cell-finish { background: var(--finish) !important; font-weight: bold; }

        #core-panel {
            position: absolute; width: 180px; height: 180px;
            background: radial-gradient(circle, #222 0%, #000 100%);
            border: 2px solid var(--gold); border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; box-shadow: 0 0 30px rgba(197, 160, 89, 0.4);
            pointer-events: auto;
        }

        #game-exit-btn { position: fixed; top: env(safe-area-inset-top, 20px); left: 20px; z-index: 2000; background: rgba(0,0,0,0.6); border: 1px solid #666; color: #fff; padding: 10px 15px; border-radius: 8px; cursor: pointer; }

        .player-token { position: absolute; font-size: 45px; z-index: 100; transition: all 0.4s; pointer-events: none; }

        textarea { width: 100%; height: 70px; background: #000; color: #fff; border: 1px solid #444; padding: 8px; font-size: 16px; border-radius: 5px; }

        #task-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: var(--modal-bg); border: 2px solid var(--gold); width: 100%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; }
    </style>
</head>
<body>

<div id="page-main" class="page active">
    <h1 style="color:var(--gold); margin-top: 10vh;">èºæ—‹å†’éšª</h1>
    <button class="btn" onclick="navTo('setup')">é–‹å§‹é›™äººéŠæˆ²</button>
    <button class="btn" style="background:#333; color:#eee;" onclick="navTo('map-editor')">åœ°åœ–ä»»å‹™ç·¨è¼¯å™¨</button>
    <button class="btn" style="background:#333; color:#eee;" onclick="navTo('truth-editor')">å»ºç«‹çœŸå¿ƒè©±é¡Œåº«</button>
</div>

<div id="page-map-editor" class="page">
    <h2>ğŸ—ºï¸ åœ°åœ–ç·¨è¼¯</h2>
    <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-bottom:15px;">
        <button class="btn-small" onclick="setEditDiff(1)">é›£åº¦ 1</button>
        <button class="btn-small" onclick="setEditDiff(2)">é›£åº¦ 2</button>
        <button class="btn-small" onclick="setEditDiff(3)">é›£åº¦ 3</button>
        <button class="btn-small" onclick="setEditDiff(4)">é›£åº¦ 4</button>
    </div>
    <div id="task-editor-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:10px; width:100%;"></div>
    <div style="margin-bottom: 50px;">
        <button class="btn" onclick="saveMapData()">å„²å­˜ç›®å‰é›£åº¦</button>
        <button class="btn btn-back" onclick="navTo('main')">è¿”å›ä¸»é </button>
    </div>
</div>

<div id="page-truth-editor" class="page">
    <h2>ğŸ¤ çœŸå¿ƒè©±é¡Œåº«</h2>
    <div class="card">
        <div style="display:flex; gap:10px;">
            <input id="new-truth-input" type="text" placeholder="è¼¸å…¥é¡Œç›®..." style="flex:1; padding:12px; background:#000; color:#fff; border:1px solid #444; font-size:16px;">
            <button onclick="saveTruth()" class="btn-small">æ–°å¢</button>
        </div>
    </div>
    <div id="truth-container" style="width:100%; max-width:600px;"></div>
    <button class="btn btn-back" onclick="navTo('main')">è¿”å›ä¸»é¸å–®</button>
</div>

<div id="page-setup" class="page">
    <h2>ğŸ‘¥ ç©å®¶è¨­å®š</h2>
    <div class="card">
        <label>é¸æ“‡é›£åº¦åœ°åœ–ï¼š</label>
        <select id="game-diff-select" style="padding:12px; width:100%; margin:10px 0; background:#000; color:#fff; border:1px solid #444; font-size:16px;">
            <option value="1">é›£åº¦ 1</option><option value="2">é›£åº¦ 2</option><option value="3">é›£åº¦ 3</option><option value="4">é›£åº¦ 4</option>
        </select>
    </div>
    <div id="player-config-inputs" style="width:100%; max-width:800px;"></div>
    <button class="btn" onclick="checkAndLaunch()">æ­£å¼é–‹å§‹éŠæˆ²</button>
    <button class="btn btn-back" onclick="navTo('main')">å–æ¶ˆ</button>
</div>

<div id="game-view">
    <button id="game-exit-btn" onclick="confirmExit()">é›¢é–‹</button>
    <div id="viewport" style="width:100%; height:100%;">
        <div id="world">
            <div id="core-panel">
                <div id="p-turn-name" style="font-weight:bold; color:var(--gold); font-size:14px;"></div>
                <div id="dice-face" style="font-size:48px; margin:5px 0;">ğŸ²</div>
                <button id="roll-btn" onclick="triggerRoll()" style="background:var(--gold); border:none; padding:10px 20px; border-radius:5px; font-weight:bold;">æ“²éª°å­</button>
            </div>
        </div>
    </div>
</div>

<div id="task-modal">
    <div class="modal-box">
        <h2 id="m-pname" style="color:var(--gold);"></h2>
        <div id="m-task" style="font-size:18px; margin:20px 0; color: #fff;"></div>
        <button class="btn" onclick="closeGameModal()" style="margin:0;">æˆ‘å®Œæˆäº†</button>
    </div>
</div>

<script>
let db = {
    maps: JSON.parse(localStorage.getItem('v13_maps')) || {
        1: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`),
        2: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`),
        3: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`),
        4: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`)
    },
    truths: JSON.parse(localStorage.getItem('v13_truths')) || ["å¤§è²èªªä¸€å€‹ç§˜å¯†", "å°å°æ–¹åšé¬¼è‡‰"]
};

let curEditDiff = 1;
let g = { players: [], tasks: [], truthMap: {}, cur: 0, moving: false, path: [] };

function navTo(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('game-view').style.display = (page === 'game') ? 'block' : 'none';
    if(page !== 'game') document.getElementById('page-'+page).classList.add('active');

    if(page === 'truth-editor') renderTruthList();
    if(page === 'setup') openSetup();
    if(page === 'map-editor') setEditDiff(1);
}

function confirmExit() {
    if(confirm("ç¢ºå®šé›¢é–‹ï¼Ÿé€²åº¦å°‡éºå¤±ã€‚")) {
        window.location.reload();
    }
}

function saveTruth() {
    const input = document.getElementById('new-truth-input');
    if(input.value.trim()) {
        db.truths.push(input.value.trim());
        localStorage.setItem('v13_truths', JSON.stringify(db.truths));
        input.value = '';
        renderTruthList();
    }
}

function renderTruthList() {
    const container = document.getElementById('truth-container');
    container.innerHTML = db.truths.map((t, i) => `
        <div class="truth-item">
            <span>${t}</span>
            <button class="btn-small" style="background:red; color:white;" onclick="removeTruth(${i})">åˆªé™¤</button>
        </div>
    `).join('');
}

function removeTruth(index) {
    db.truths.splice(index, 1);
    localStorage.setItem('v13_truths', JSON.stringify(db.truths));
    renderTruthList();
}

function setEditDiff(n) {
    curEditDiff = n;
    const grid = document.getElementById('task-editor-grid');
    grid.innerHTML = '';
    db.maps[n].forEach((txt, i) => {
        grid.innerHTML += `
            <div class="card">
                <b>æ ¼ ${i+1}</b>
                <textarea id="task-txt-${i}">${txt}</textarea>
                <button class="btn-small" onclick="document.getElementById('task-txt-${i}').value += 'ğŸ­'">æ’å…¥ ğŸ­</button>
            </div>`;
    });
}

function saveMapData() {
    for(let i=0; i<48; i++) {
        db.maps[curEditDiff][i] = document.getElementById('task-txt-'+i).value;
    }
    localStorage.setItem('v13_maps', JSON.stringify(db.maps));
    alert('å„²å­˜æˆåŠŸï¼');
}

function openSetup() {
    const box = document.getElementById('player-config-inputs');
    box.innerHTML = '';
    for(let i=0; i<2; i++) {
        box.innerHTML += `
        <div class="card">
            P${i+1} åç¨±: <input id="pn-input-${i}" value="ç©å®¶${i+1}" style="background:#000; color:#fff; border:1px solid #444; padding:8px; font-size:16px;"><br><br>
            è§’è‰²: <select id="pe-input-${i}" style="padding:5px;">${['ğŸ±','ğŸ¦Š','ğŸ·','ğŸ¤–','ğŸ§›','ğŸ§™','ğŸ™','ğŸ¦'].map((e,idx) => `<option ${idx===i?'selected':''}>${e}</option>`).join('')}</select>
            æ€§åˆ¥: <select id="pg-input-${i}"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        </div>`;
    }
}

function checkAndLaunch() {
    const diff = document.getElementById('game-diff-select').value;
    g.tasks = [...db.maps[diff]];
    g.players = [0,1].map(i => ({
        name: document.getElementById(`pn-input-${i}`).value,
        gen: document.getElementById(`pg-input-${i}`).value,
        emo: document.getElementById(`pe-input-${i}`).value,
        pos: 0
    }));
    navTo('game');
    setTimeout(drawSpiralWorld, 200);
}

function drawSpiralWorld() {
    const world = document.getElementById('world');
    world.innerHTML = '<div id="core-panel"><div id="p-turn-name" style="font-weight:bold; color:var(--gold); font-size:14px;"></div><div id="dice-face" style="font-size:48px; margin:5px 0;">ğŸ²</div><button id="roll-btn" onclick="triggerRoll()" style="background:var(--gold); border:none; padding:10px 20px; border-radius:5px; font-weight:bold;">æ“²éª°å­</button></div>';

    g.path = []; g.truthMap = {};
    const cellSize = 92;
    let x=0, y=0, dx=1, dy=0, step=7, left=step, turnC=0;

    for(let i=0; i<50; i++) {
        g.path.push({ x: x*cellSize, y: y*cellSize, isTurn: (left===1) });
        if(--left === 0) {
            let tmp=dx; dx=-dy; dy=tmp; // ä¿®æ­£èªæ³•éŒ¯èª¤
            if(++turnC % 2 === 0) step--;
            left = Math.max(step, 1);
        }
        x+=dx; y+=dy;
    }

    const core = document.getElementById('core-panel');
    core.style.left = (2 * cellSize) + "px";
    core.style.top = (2 * cellSize) + "px";

    g.path.forEach((pos, i) => {
        const c = document.createElement('div');
        c.className = 'cell' + (i===49?' cell-finish':'');
        c.style.left = pos.x + 'px'; c.style.top = pos.y + 'px';
        let raw = (i===0)?"èµ·é»":(i===49)?"çµ‚é»":g.tasks[i-1];
        c.innerHTML = `<span style="opacity:0.2; font-size:9px">${i}</span><div style="font-size:10px">${raw.replace(/ğŸ­/g, "ğŸ‘¤")}</div>`;

        if(pos.isTurn && i>0 && i<49) {
            const t = document.createElement('div'); t.style.color="var(--gold)"; t.style.fontSize="9px"; t.innerText="çœŸå¿ƒè©±";
            c.appendChild(t);
            g.truthMap[i] = db.truths[Math.floor(Math.random()*db.truths.length)] || "çœŸå¿ƒè©±";
        }
        world.appendChild(c);
    });
    updateTokens();
    camX = window.innerWidth/2 - (92*3.5); camY = window.innerHeight/2 - (92*3.5);
    refreshCam();
    updateGameUI();
}

function updateTokens() {
    document.querySelectorAll('.tk').forEach(t=>t.remove());
    g.players.forEach((p, i) => {
        const pos = g.path[p.pos];
        const t = document.createElement('div');
        t.className = 'player-token tk'; t.textContent = p.emo;
        t.style.left = (pos.x + 20 + i*5) + 'px'; t.style.top = (pos.y + 15) + 'px';
        document.getElementById('world').appendChild(t);
    });
}

function triggerRoll() {
    if(g.moving) return;
    g.moving = true;
    const btn = document.getElementById('roll-btn');
    btn.disabled = true;
    let count = 0;
    const anim = setInterval(() => {
        document.getElementById('dice-face').innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][Math.floor(Math.random()*6)];
        if(count++ > 10) {
            clearInterval(anim);
            const val = Math.floor(Math.random()*6)+1;
            document.getElementById('dice-face').innerText = ['','âš€','âš','âš‚','âšƒ','âš„','âš…'][val];
            executeMove(val);
        }
    }, 60);
}

function executeMove(steps) {
    let p = g.players[g.cur];
    let s = 0;
    const inv = setInterval(() => {
        p.pos = Math.min(p.pos + 1, 49);
        updateTokens();
        if(++s >= steps || p.pos === 49) {
            clearInterval(inv);
            setTimeout(() => {
                let taskText = (p.pos===0)?"èµ·é»":(p.pos===49)?"çµ‚é»":g.tasks[p.pos-1];
                if(taskText.includes("ğŸ­")) {
                    const other = g.players.find((_,idx)=>idx!==g.cur);
                    taskText = taskText.replace(/ğŸ­/g, `<b style="color:var(--accent)">${other.name}</b>`);
                }
                const truth = g.truthMap[p.pos] ? `<br><br><span style="color:var(--gold)">ğŸ¤ çœŸå¿ƒè©±ï¼š${g.truthMap[p.pos]}</span>` : "";
                document.getElementById('m-pname').innerText = `${p.emo} ${p.name}`;
                document.getElementById('m-task').innerHTML = taskText + truth;
                document.getElementById('task-modal').style.display = 'flex';
            }, 500);
        }
    }, 300);
}

function closeGameModal() {
    document.getElementById('task-modal').style.display = 'none';
    if(g.players[g.cur].pos === 49) {
        alert("å‹åˆ©ï¼"); window.location.reload();
    } else {
        g.cur = (g.cur+1)%2;
        g.moving = false;
        document.getElementById('roll-btn').disabled = false;
        updateGameUI();
    }
}

function updateGameUI() {
    document.getElementById('p-turn-name').innerText = `è¼ªåˆ°ï¼š${g.players[g.cur].name}`;
}

let camX=0, camY=0, camS=0.8;
function refreshCam() { document.getElementById('world').style.transform = `translate(${camX}px, ${camY}px) scale(${camS})`; }

// iPhone ç¸®æ”¾èˆ‡ç§»å‹•ä¿®å¾©
window.addEventListener('wheel', (e) => {
    if(document.getElementById('game-view').style.display === 'block') {
        camS = Math.min(Math.max(0.3, camS + (e.deltaY < 0 ? 0.05 : -0.05)), 1.5);
        refreshCam();
    }
}, {passive: false});

let isP = false, lx, ly;
window.addEventListener('pointerdown', (e) => {
    if(e.target.id==='viewport' || e.target.id==='world') { isP=true; lx=e.clientX; ly=e.clientY; }
});
window.addEventListener('pointermove', (e) => {
    if(isP) { camX+=(e.clientX-lx); camY+=(e.clientY-ly); lx=e.clientX; ly=e.clientY; refreshCam(); }
});
window.addEventListener('pointerup', () => isP=false);

</script>
</body>
</html>