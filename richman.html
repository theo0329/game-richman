<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èºæ—‹å†’éšª V11 - ä¿®æ­£ç‰ˆ</title>
    <style>
        :root { --bg: #0d0d0d; --gold: #c5a059; --finish: #e67e22; --border: #333; --accent: #ff6b6b; --modal-bg: rgba(20,20,20,0.98); }
        * { box-sizing: border-box; touch-action: none; }
        body, html { background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }

        /* ä»‹é¢åˆ‡æ› */
        .page { position: absolute; inset: 0; z-index: 1000; background: #111; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .active { display: flex; }

        .btn { width: 100%; max-width: 300px; padding: 15px; margin: 8px; background: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; text-align: center; }
        .card { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); width: 100%; max-width: 800px; }

        /* çœŸå¿ƒè©±ç·¨è¼¯å°ˆå±¬æ¨£å¼ */
        .truth-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 10px; border-radius: 5px; margin-bottom: 5px; border-left: 4px solid var(--accent); }
        .del-btn { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* éŠæˆ²å€åŸŸ */
        #game-view { position: fixed; inset: 0; width: 100vw; height: 100vh; background: #000; z-index: 500; display: none; }
        #world { position: absolute; transform-origin: center; }
        .cell { position: absolute; width: 90px; height: 90px; border: 1px solid var(--border); background: #161616; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 5px; font-size: 11px; }

        /* åµŒå…¥å¼æ§åˆ¶ä¸­å¿ƒ */
        #core-panel {
            position: absolute; width: 180px; height: 180px;
            background: radial-gradient(circle, #222 0%, #000 100%);
            border: 2px solid var(--gold); border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; box-shadow: 0 0 30px rgba(197, 160, 89, 0.4);
            pointer-events: auto;
        }

        .player-token { position: absolute; font-size: 45px; z-index: 100; transition: all 0.4s; filter: drop-shadow(0 4px 4px #000); pointer-events: none; }

        /* å½ˆçª— */
        #task-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--modal-bg); border: 2px solid var(--gold); width: 100%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; }
    </style>
</head>
<body>

<div id="page-main" class="page active">
    <h1 style="color:var(--gold); margin-top: 5vh;">èºæ—‹å†’éšª V11</h1>
    <button class="btn" onclick="openSetup()">é€²å…¥éŠæˆ²è¨­å®š</button>
    <button class="btn" style="background:#444;" onclick="navTo('map-editor')">åœ°åœ–ä»»å‹™ç·¨è¼¯å™¨</button>
    <button class="btn" style="background:#444;" onclick="navTo('truth-editor')">å»ºç«‹çœŸå¿ƒè©±é¡Œåº«</button>
</div>

<div id="page-truth-editor" class="page">
    <h2>ğŸ¤ çœŸå¿ƒè©±é¡Œåº«ç®¡ç†</h2>
    <div class="card">
        <div style="display:flex; gap:10px;">
            <input id="new-truth-input" type="text" placeholder="è¼¸å…¥é¡Œç›®å…§å®¹..." style="flex:1; padding:10px; background:#000; color:#fff; border:1px solid #444;">
            <button onclick="saveTruth()" style="background:var(--gold); border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">æ–°å¢</button>
        </div>
    </div>
    <div id="truth-container" style="width:100%; max-width:600px;">
        </div>
    <button class="btn" style="margin-top:20px;" onclick="navTo('main')">è¿”å›ä¸»é¸å–®</button>
</div>

<div id="page-map-editor" class="page">
    <h2>ğŸ—ºï¸ åœ°åœ–ç·¨è¼¯</h2>
    <div style="display:flex; gap:5px; margin-bottom:15px; width:100%; max-width:800px;">
        <button class="btn" style="flex:1; font-size:12px;" onclick="setEditDiff(1)">é›£åº¦ 1</button>
        <button class="btn" style="flex:1; font-size:12px;" onclick="setEditDiff(2)">é›£åº¦ 2</button>
        <button class="btn" style="flex:1; font-size:12px;" onclick="setEditDiff(3)">é›£åº¦ 3</button>
        <button class="btn" style="flex:1; font-size:12px;" onclick="setEditDiff(4)">é›£åº¦ 4</button>
    </div>
    <div id="task-editor-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:10px; width:100%;"></div>
    <button class="btn" style="margin:20px 0;" onclick="saveMapData()">å„²å­˜åœ°åœ–è³‡æ–™</button>
</div>

<div id="page-setup" class="page">
    <h2>ğŸ‘¥ ç©å®¶è¨­å®š</h2>
    <div class="card">
        <label>é¸æ“‡é›£åº¦åœ°åœ–ï¼š</label>
        <select id="game-diff-select" style="padding:10px; width:100%; margin:10px 0; background:#000; color:#fff; border:1px solid #444;">
            <option value="1">é›£åº¦ 1</option><option value="2">é›£åº¦ 2</option><option value="3">é›£åº¦ 3</option><option value="4">é›£åº¦ 4</option>
        </select>
    </div>
    <div id="player-config-inputs" style="width:100%; max-width:800px;"></div>
    <button class="btn" onclick="checkAndLaunch()">æ­£å¼é–‹å§‹éŠæˆ²</button>
</div>

<div id="game-view">
    <div id="viewport" style="width:100%; height:100%;">
        <div id="world">
            <div id="core-panel">
                <div id="p-turn-name" style="font-weight:bold; color:var(--gold); font-size:14px;"></div>
                <div id="dice-face" style="font-size:48px; margin:5px 0;">ğŸ²</div>
                <button id="roll-btn" onclick="triggerRoll()" style="background:var(--gold); border:none; padding:8px 15px; border-radius:5px; font-weight:bold; cursor:pointer;">æ“²éª°å­</button>
            </div>
        </div>
    </div>
</div>

<div id="task-modal">
    <div class="modal-content">
        <h2 id="m-pname" style="color:var(--gold);"></h2>
        <div id="m-task" style="font-size:18px; margin:20px 0;"></div>
        <button class="btn" onclick="closeGameModal()">å®Œæˆä»»å‹™</button>
    </div>
</div>

<script>
// --- è³‡æ–™åº«ç®¡ç† ---
let db = {
    maps: JSON.parse(localStorage.getItem('v11_maps')) || {
        1: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`), 2: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`),
        3: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`), 4: Array(48).fill().map((_,i)=>`ä»»å‹™ ${i+1}`)
    },
    truths: JSON.parse(localStorage.getItem('v11_truths')) || ["å¤§è²èªªå‡ºä½ æœ€è¿‘çš„ä¸€å€‹è¬Šè¨€", "å°å°æ–¹åšä¸€å€‹é¬¼è‡‰"]
};

let curEditDiff = 1;
let g = { players: [], tasks: [], truthMap: {}, cur: 0, moving: false, path: [] };

// --- å°è¦½èˆ‡çœŸå¿ƒè©±é‚è¼¯ ---
function navTo(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('game-view').style.display = (page === 'game') ? 'block' : 'none';
    if(page !== 'game') document.getElementById('page-'+page).classList.add('active');
    if(page === 'truth-editor') renderTruthList();
}

function saveTruth() {
    const input = document.getElementById('new-truth-input');
    if(input.value.trim()) {
        db.truths.push(input.value.trim());
        localStorage.setItem('v11_truths', JSON.stringify(db.truths));
        input.value = '';
        renderTruthList();
    }
}

function renderTruthList() {
    const container = document.getElementById('truth-container');
    container.innerHTML = db.truths.map((t, i) => `
        <div class="truth-item">
            <span>${i+1}. ${t}</span>
            <button class="del-btn" onclick="removeTruth(${i})">åˆªé™¤</button>
        </div>
    `).join('');
}

function removeTruth(index) {
    db.truths.splice(index, 1);
    localStorage.setItem('v11_truths', JSON.stringify(db.truths));
    renderTruthList();
}

// --- åœ°åœ–ç·¨è¼¯å™¨ ---
function setEditDiff(n) {
    curEditDiff = n;
    const grid = document.getElementById('task-editor-grid');
    grid.innerHTML = '';
    db.maps[n].forEach((txt, i) => {
        grid.innerHTML += `
            <div class="card">
                <b>æ ¼ ${i+1}</b>
                <textarea id="task-txt-${i}">${txt}</textarea>
                <button onclick="document.getElementById('task-txt-${i}').value += 'ğŸ­'" style="font-size:10px; cursor:pointer;">æ’å…¥ ğŸ­ (ä»£è¡¨å°æ–¹)</button>
            </div>`;
    });
}

function saveMapData() {
    for(let i=0; i<48; i++) db.maps[curEditDiff][i] = document.getElementById('task-txt-'+i).value;
    localStorage.setItem('v11_maps', JSON.stringify(db.maps));
    alert('é›£åº¦ ' + curEditDiff + ' å„²å­˜æˆåŠŸï¼');
    navTo('main');
}

// --- éŠæˆ²è¨­å®šèˆ‡å•Ÿå‹• ---
function openSetup() {
    navTo('setup');
    const box = document.getElementById('player-config-inputs');
    box.innerHTML = '';
    const emojis = ['ğŸ±','ğŸ¦Š','ğŸ·','ğŸ¤–','ğŸ§›','ğŸ§™','ğŸ™','ğŸ¦'];
    for(let i=0; i<2; i++) {
        box.innerHTML += `
            <div class="card">
                ç©å®¶ ${i+1} åç¨±: <input id="pn-input-${i}" value="Player ${i+1}" style="background:#000; color:#fff; border:1px solid #444; padding:5px;">
                æ€§åˆ¥: <select id="pg-input-${i}"><option value="M">ç”·</option><option value="F">å¥³</option></select>
                è§’è‰²: <select id="pe-input-${i}" onchange="syncEmojis(${i})">
                    ${emojis.map((e,idx) => `<option ${idx===i?'selected':''}>${e}</option>`).join('')}
                </select>
            </div>`;
    }
}

function syncEmojis(idx) {
    const e0 = document.getElementById('pe-input-0').value;
    const e1 = document.getElementById('pe-input-1').value;
    if(e0 === e1) {
        alert("ä¸èƒ½é¸æ“‡ç›¸åŒè§’è‰²ï¼");
        const sel = document.getElementById(`pe-input-${idx}`);
        sel.selectedIndex = (sel.selectedIndex + 1) % 8;
    }
}

function checkAndLaunch() {
    const diff = document.getElementById('game-diff-select').value;
    g.tasks = [...db.maps[diff]];
    g.players = [0,1].map(i => ({
        name: document.getElementById(`pn-input-${i}`).value,
        gen: document.getElementById(`pg-input-${i}`).value,
        emo: document.getElementById(`pe-input-${i}`).value,
        pos: 0
    }));
    navTo('game');
    setTimeout(drawSpiralWorld, 300);
}

// --- èºæ—‹å¼•æ“ ---
function drawSpiralWorld() {
    const world = document.getElementById('world');
    world.querySelectorAll('.cell, .player-token').forEach(el => el.remove());
    g.path = []; g.truthMap = {};

    let x=0, y=0, dx=1, dy=0, step=7, left=step, turnC=0;
    for(let i=0; i<50; i++) {
        g.path.push({ x: x*92, y: y*92, isTurn: (left===1) });
        if(--left === 0) {
            let tmp=dx; dx=-dy; dy=tmp;
            if(++turnC % 2 === 0) step--;
            left = step;
        }
        x+=dx; y+=dy;
    }

    // æ ¸å¿ƒé¢æ¿å®šä½
    const core = document.getElementById('core-panel');
    core.style.left = (2 * 92) + "px";
    core.style.top = (2 * 92) + "px";

    g.path.forEach((pos, i) => {
        const c = document.createElement('div');
        c.className = 'cell' + (i===49?' cell-finish':'');
        c.style.left = pos.x + 'px'; c.style.top = pos.y + 'px';
        let raw = (i===0)?"èµ·é»":(i===49)?"çµ‚é»":g.tasks[i-1];
        c.innerHTML = `<span style="opacity:0.2; font-size:9px">${i}</span><div style="font-size:10px">${raw.replace(/ğŸ­/g, "ğŸ‘¤")}</div>`;

        if(pos.isTurn && i>0 && i<49) {
            const t = document.createElement('div'); t.style.color="var(--gold)"; t.style.fontSize="9px"; t.innerText="çœŸå¿ƒè©±";
            c.appendChild(t);
            // å¾é¡Œåº«éš¨æ©ŸæŠ½
            g.truthMap[i] = db.truths[Math.floor(Math.random()*db.truths.length)] || "çœŸå¿ƒè©±å†·å»ä¸­...";
        }
        world.appendChild(c);
    });

    updateTokens();
    camX = window.innerWidth/2 - (92*3.5); camY = window.innerHeight/2 - (92*3.5);
    refreshCam();
    updateGameUI();
}

function updateTokens() {
    document.querySelectorAll('.tk').forEach(t=>t.remove());
    g.players.forEach((p, i) => {
        const pos = g.path[p.pos];
        const t = document.createElement('div');
        t.className = 'player-token tk'; t.textContent = p.emo;
        t.style.left = (pos.x + 20 + i*5) + 'px'; t.style.top = (pos.y + 15) + 'px';
        document.getElementById('world').appendChild(t);
    });
}

// --- éª°å­é‚è¼¯ ---
function triggerRoll() {
    if(g.moving) return;
    g.moving = true;
    document.getElementById('roll-btn').disabled = true;
    let count = 0;
    let anim = setInterval(() => {
        document.getElementById('dice-face').innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][Math.floor(Math.random()*6)];
        if(count++ > 12) {
            clearInterval(anim);
            const val = Math.floor(Math.random()*6)+1;
            document.getElementById('dice-face').innerText = ['','âš€','âš','âš‚','âšƒ','âš„','âš…'][val];
            executeMove(val);
        }
    }, 60);
}

function executeMove(steps) {
    let p = g.players[g.cur];
    let s = 0;
    let inv = setInterval(() => {
        p.pos = Math.min(p.pos + 1, 49);
        updateTokens();
        if(++s >= steps || p.pos === 49) {
            clearInterval(inv);
            setTimeout(() => {
                let taskText = (p.pos===0)?"èµ·é»":(p.pos===49)?"çµ‚é»":g.tasks[p.pos-1];
                if(taskText.includes("ğŸ­")) {
                    const other = g.players.find((_,idx)=>idx!==g.cur);
                    taskText = taskText.replace(/ğŸ­/g, `<b style="color:var(--accent)">${other.name}</b>`);
                }
                const truth = g.truthMap[p.pos] ? `<br><br><span style="color:var(--gold)">ğŸ¤ çœŸå¿ƒè©±ï¼š${g.truthMap[p.pos]}</span>` : "";

                document.getElementById('m-pname').innerText = `${p.emo} ${p.name}`;
                document.getElementById('m-task').innerHTML = taskText + truth;
                document.getElementById('task-modal').style.display = 'flex';
            }, 500);
        }
    }, 300);
}

function closeGameModal() {
    document.getElementById('task-modal').style.display = 'none';
    if(g.players[g.cur].pos === 49) {
        alert("å‹åˆ©ï¼"); location.reload();
    } else {
        g.cur = (g.cur+1)%2;
        g.moving = false;
        document.getElementById('roll-btn').disabled = false;
        updateGameUI();
    }
}

function updateGameUI() {
    const p = g.players[g.cur];
    document.getElementById('p-turn-name').innerText = `è¼ªåˆ°ï¼š${p.name}`;
}

// --- æ§åˆ¶ç³»çµ± ---
let camX=0, camY=0, camS=0.8;
function refreshCam() { document.getElementById('world').style.transform = `translate(${camX}px, ${camY}px) scale(${camS})`; }
window.onwheel = (e) => { camS = Math.min(Math.max(0.3, camS + (e.deltaY<0?0.05:-0.05)), 1.5); refreshCam(); };
let isP = false, lx, ly;
window.onpointerdown = (e) => { if(e.target.id==='viewport' || e.target.id==='world') { isP=true; lx=e.clientX; ly=e.clientY; } };
window.onpointermove = (e) => { if(isP) { camX+=(e.clientX-lx); camY+=(e.clientY-ly); lx=e.clientX; ly=e.clientY; refreshCam(); } };
window.onpointerup = () => isP=false;

// åˆå§‹åŠ è¼‰
setEditDiff(1);
</script>
</body>
</html>